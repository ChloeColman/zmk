/*
 * Copyright (c) 2024 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 *
 * Bongocat widget for nice_view_gem display
 * Sprites based on HorrorTroll's design, converted for LVGL
 */

#include <zephyr/kernel.h>
#include <stdio.h>
#include <stdbool.h>
#include "bongo_cat.h"
#include "../assets/custom_fonts.h"

#ifndef LV_ATTRIBUTE_MEM_ALIGN
#define LV_ATTRIBUTE_MEM_ALIGN
#endif

// Frame tracking
static int64_t last_keypress_time = 0;
static uint32_t last_keypress_counter = 0;
static bool current_paw = false;  // For alternating paws on keypress

/*
 * Bongocat sprites - 64x32 pixels, 1-bit indexed
 * Converted from HorrorTroll's QMK bongocat design
 * 8-byte palette + 256 bytes pixel data = 264 bytes per frame
 */

// Idle frame - cat relaxed, both paws resting (HorrorTroll style, columns 16-80)
const LV_ATTRIBUTE_MEM_ALIGN uint8_t bongo_idle_map[] = {
#if IS_ENABLED(CONFIG_NICE_VIEW_WIDGET_INVERTED)
    0xff, 0xff, 0xff, 0xff, /*Color of index 0*/
    0x00, 0x00, 0x00, 0xff, /*Color of index 1*/
#else
    0x00, 0x00, 0x00, 0xff, /*Color of index 0*/
    0xff, 0xff, 0xff, 0xff, /*Color of index 1*/
#endif
    // 64x32 pixel data - HorrorTroll bongocat (idle, columns 16-80)
    0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x80, 0x78,
    0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe1, 0xf8,
    0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0xf0, 0x00, 0x3f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0x00, 0x7f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xf0, 0xff, 0xff, 0xb7, 0xff, 0xff, 0xf0,
    0x00, 0x0f, 0xff, 0xff, 0xce, 0xff, 0xff, 0xf0,
    0x00, 0x01, 0xff, 0xff, 0xf9, 0xf3, 0xff, 0xe0,
    0x00, 0x03, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xf0,
    0x00, 0x3b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x00, 0x67, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xc7, 0xfc, 0x00, 0xff, 0xff, 0xff, 0xf8,
    0x01, 0xef, 0xfd, 0xc0, 0x0f, 0xff, 0xff, 0xfc,
    0x03, 0x0f, 0xf8, 0x3c, 0x00, 0xff, 0xff, 0xfc,
    0x07, 0x07, 0xf6, 0x33, 0xc0, 0x0f, 0xff, 0xfc,
    0x0d, 0x99, 0xc1, 0xe0, 0xfc, 0x03, 0xff, 0xfe,
    0x18, 0x76, 0x20, 0xf1, 0x83, 0xc7, 0xff, 0xfe,
    0x1e, 0x61, 0xf1, 0x8f, 0xc6, 0x2f, 0xfe, 0xfe,
    0x01, 0xe1, 0x8f, 0x06, 0x3c, 0x1f, 0xfc, 0x0f,
    0x00, 0x5f, 0x07, 0xcc, 0x1e, 0x1f, 0xf8, 0x00,
    0x80, 0xc1, 0xec, 0x3f, 0x33, 0xef, 0xe3, 0xc0,
    0xe3, 0x80, 0x1e, 0x30, 0xe0, 0xc7, 0x83, 0x3c,
    0x3e, 0x00, 0x01, 0xe0, 0xc1, 0x80, 0x46, 0x0c,
};

// Left tap - left paw raised (HorrorTroll style, columns 16-80)
const LV_ATTRIBUTE_MEM_ALIGN uint8_t bongo_left_map[] = {
#if IS_ENABLED(CONFIG_NICE_VIEW_WIDGET_INVERTED)
    0xff, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0xff,
#else
    0x00, 0x00, 0x00, 0xff,
    0xff, 0xff, 0xff, 0xff,
#endif
    // 64x32 pixel data - HorrorTroll bongocat (left paw tap, columns 16-80)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7f, 0xff, 0xfc, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x80, 0x78,
    0x00, 0x00, 0x71, 0xff, 0xff, 0xff, 0xe1, 0xf8,
    0x00, 0x00, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0x01, 0xbb, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0xf0, 0x03, 0xeb, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0x03, 0x7d, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xf3, 0x9d, 0xff, 0xb7, 0xff, 0xff, 0xf0,
    0x00, 0x0f, 0x9f, 0xff, 0xce, 0xff, 0xff, 0xf0,
    0x00, 0x00, 0xff, 0xff, 0xf9, 0xf3, 0xff, 0xe0,
    0x00, 0x00, 0x0f, 0xff, 0xff, 0xf3, 0xff, 0xf0,
    0x00, 0x3c, 0x00, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x00, 0x63, 0xc0, 0x0f, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xc1, 0xbc, 0x00, 0xff, 0xff, 0xff, 0xf8,
    0x01, 0xe3, 0x07, 0xc0, 0x0f, 0xff, 0xff, 0xfc,
    0x03, 0x1f, 0x8c, 0x3c, 0x00, 0xff, 0xff, 0xfc,
    0x07, 0x0c, 0x7e, 0x33, 0xc0, 0x0f, 0xff, 0xfc,
    0x0d, 0x9c, 0x31, 0xe0, 0xfc, 0x03, 0xff, 0xfe,
    0x18, 0x76, 0x60, 0xf1, 0x83, 0xc7, 0xff, 0xfe,
    0x1e, 0x61, 0xf1, 0x8f, 0xc6, 0x2f, 0xfe, 0xfe,
    0x01, 0xe1, 0x8f, 0x06, 0x3c, 0x1f, 0xfc, 0x0f,
    0x00, 0x5f, 0x07, 0xcc, 0x1e, 0x1f, 0xf8, 0x00,
    0x80, 0xc1, 0xec, 0x3f, 0x33, 0xef, 0xe3, 0xc0,
    0xe3, 0x80, 0x1e, 0x30, 0xe0, 0xc7, 0x83, 0x3c,
    0x3e, 0x00, 0x01, 0xe0, 0xc1, 0x80, 0x46, 0x0c,
};

// Right tap - right paw raised (HorrorTroll style, columns 16-80)
const LV_ATTRIBUTE_MEM_ALIGN uint8_t bongo_right_map[] = {
#if IS_ENABLED(CONFIG_NICE_VIEW_WIDGET_INVERTED)
    0xff, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0xff,
#else
    0x00, 0x00, 0x00, 0xff,
    0xff, 0xff, 0xff, 0xff,
#endif
    // 64x32 pixel data - HorrorTroll bongocat (right paw tap, columns 16-80)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7f, 0xff, 0xfc, 0x00, 0x00,
    0x00, 0x38, 0x00, 0xff, 0xff, 0xff, 0x80, 0x78,
    0x00, 0x78, 0x01, 0xff, 0xff, 0xff, 0xe1, 0xf8,
    0x00, 0x7c, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0x3c, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0xf0, 0x1e, 0x3f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0x00, 0x7f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xf0, 0xff, 0xff, 0xb7, 0xff, 0xc7, 0xf0,
    0x0c, 0x0f, 0xff, 0xff, 0xce, 0xff, 0xbb, 0xf0,
    0x1f, 0x81, 0xff, 0xff, 0xf9, 0xf3, 0x5d, 0xe0,
    0x1f, 0x03, 0xff, 0xff, 0xff, 0xf2, 0xf5, 0xf0,
    0x1e, 0x3b, 0xff, 0xff, 0xff, 0xfe, 0x7e, 0xf0,
    0x0c, 0x67, 0xfe, 0x0f, 0xff, 0xfe, 0xce, 0xf8,
    0x00, 0xc7, 0xfc, 0x00, 0xff, 0xfe, 0xcf, 0xf8,
    0x01, 0xef, 0xfd, 0xc0, 0x0f, 0xfe, 0xff, 0xfc,
    0x03, 0x0f, 0xf8, 0x3c, 0x00, 0xfe, 0xff, 0xfc,
    0x07, 0x07, 0xf6, 0x33, 0xc0, 0x0f, 0xff, 0xfc,
    0x0d, 0x99, 0xc1, 0xe0, 0xfc, 0x00, 0xff, 0xfe,
    0x18, 0x76, 0x20, 0xf1, 0x83, 0xc0, 0x0f, 0xfe,
    0x1e, 0x61, 0xf1, 0x8f, 0xc6, 0x3c, 0x00, 0xfe,
    0x01, 0xe1, 0x8f, 0x06, 0x3c, 0x1b, 0xc0, 0x0f,
    0x00, 0x5f, 0x07, 0xcc, 0x1e, 0x30, 0x7c, 0x00,
    0x80, 0xc1, 0xec, 0x3f, 0x33, 0xf8, 0xc3, 0xc0,
    0xe3, 0x80, 0x1e, 0x30, 0xe0, 0xc7, 0x83, 0x3c,
    0x3e, 0x00, 0x01, 0xe0, 0xc1, 0x83, 0xc6, 0x0c,
};

// Both paws tap - fast typing (HorrorTroll style, uses idle frame, columns 16-80)
const LV_ATTRIBUTE_MEM_ALIGN uint8_t bongo_both_map[] = {
#if IS_ENABLED(CONFIG_NICE_VIEW_WIDGET_INVERTED)
    0xff, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0xff,
#else
    0x00, 0x00, 0x00, 0xff,
    0xff, 0xff, 0xff, 0xff,
#endif
    // 64x32 pixel data - uses idle frame for "both" animation (columns 16-80)
    0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x07, 0xff, 0xf0, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x80, 0x78,
    0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xe1, 0xf8,
    0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf8,
    0xf0, 0x00, 0x3f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x0f, 0x00, 0x7f, 0xf9, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xf0, 0xff, 0xff, 0xb7, 0xff, 0xff, 0xf0,
    0x00, 0x0f, 0xff, 0xff, 0xce, 0xff, 0xff, 0xf0,
    0x00, 0x01, 0xff, 0xff, 0xf9, 0xf3, 0xff, 0xe0,
    0x00, 0x03, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xf0,
    0x00, 0x3b, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0,
    0x00, 0x67, 0xfe, 0x0f, 0xff, 0xff, 0xff, 0xf8,
    0x00, 0xc7, 0xfc, 0x00, 0xff, 0xff, 0xff, 0xf8,
    0x01, 0xef, 0xfd, 0xc0, 0x0f, 0xff, 0xff, 0xfc,
    0x03, 0x0f, 0xf8, 0x3c, 0x00, 0xff, 0xff, 0xfc,
    0x07, 0x07, 0xf6, 0x33, 0xc0, 0x0f, 0xff, 0xfc,
    0x0d, 0x99, 0xc1, 0xe0, 0xfc, 0x03, 0xff, 0xfe,
    0x18, 0x76, 0x20, 0xf1, 0x83, 0xc7, 0xff, 0xfe,
    0x1e, 0x61, 0xf1, 0x8f, 0xc6, 0x2f, 0xfe, 0xfe,
    0x01, 0xe1, 0x8f, 0x06, 0x3c, 0x1f, 0xfc, 0x0f,
    0x00, 0x5f, 0x07, 0xcc, 0x1e, 0x1f, 0xf8, 0x00,
    0x80, 0xc1, 0xec, 0x3f, 0x33, 0xef, 0xe3, 0xc0,
    0xe3, 0x80, 0x1e, 0x30, 0xe0, 0xc7, 0x83, 0x3c,
    0x3e, 0x00, 0x01, 0xe0, 0xc1, 0x80, 0x46, 0x0c,
};

// LVGL image descriptors
const lv_img_dsc_t bongo_idle = {
    .header.cf = LV_IMG_CF_INDEXED_1BIT,
    .header.always_zero = 0,
    .header.reserved = 0,
    .header.w = BONGO_CAT_WIDTH,
    .header.h = BONGO_CAT_HEIGHT,
    .data_size = 8 + (BONGO_CAT_WIDTH / 8) * BONGO_CAT_HEIGHT,
    .data = bongo_idle_map,
};

const lv_img_dsc_t bongo_left = {
    .header.cf = LV_IMG_CF_INDEXED_1BIT,
    .header.always_zero = 0,
    .header.reserved = 0,
    .header.w = BONGO_CAT_WIDTH,
    .header.h = BONGO_CAT_HEIGHT,
    .data_size = 8 + (BONGO_CAT_WIDTH / 8) * BONGO_CAT_HEIGHT,
    .data = bongo_left_map,
};

const lv_img_dsc_t bongo_right = {
    .header.cf = LV_IMG_CF_INDEXED_1BIT,
    .header.always_zero = 0,
    .header.reserved = 0,
    .header.w = BONGO_CAT_WIDTH,
    .header.h = BONGO_CAT_HEIGHT,
    .data_size = 8 + (BONGO_CAT_WIDTH / 8) * BONGO_CAT_HEIGHT,
    .data = bongo_right_map,
};

const lv_img_dsc_t bongo_both = {
    .header.cf = LV_IMG_CF_INDEXED_1BIT,
    .header.always_zero = 0,
    .header.reserved = 0,
    .header.w = BONGO_CAT_WIDTH,
    .header.h = BONGO_CAT_HEIGHT,
    .data_size = 8 + (BONGO_CAT_WIDTH / 8) * BONGO_CAT_HEIGHT,
    .data = bongo_both_map,
};


static const lv_img_dsc_t *get_current_frame(uint32_t keypress_counter) {
    int64_t now = k_uptime_get();

    // Detect new keypress by counter change
    if (keypress_counter != last_keypress_counter) {
        current_paw = !current_paw;
        last_keypress_time = now;
        last_keypress_counter = keypress_counter;
    }

    // Keep paw down for 150ms after keypress
    if (now - last_keypress_time < 150) {
        return current_paw ? &bongo_left : &bongo_right;
    }

    // Return to idle
    return &bongo_idle;
}

void draw_bongo_cat(lv_obj_t *canvas, const struct status_state *state) {
    uint8_t current_wpm = state->wpm[WPM_HISTORY_SIZE - 1];

    const lv_img_dsc_t *frame = get_current_frame(state->keypress_counter);

    lv_draw_img_dsc_t img_dsc;
    lv_draw_img_dsc_init(&img_dsc);
    lv_canvas_draw_img(canvas, BONGO_CAT_X, BONGO_CAT_Y, frame, &img_dsc);

    // Draw WPM text below layer name - centered with larger font
    lv_draw_label_dsc_t label_dsc;
    lv_draw_label_dsc_init(&label_dsc);
    label_dsc.color = IS_ENABLED(CONFIG_NICE_VIEW_WIDGET_INVERTED) ? lv_color_black() : lv_color_white();
    label_dsc.font = &quinquefive_24;
    label_dsc.align = LV_TEXT_ALIGN_CENTER;

    char wpm_text[16];
    snprintf(wpm_text, sizeof(wpm_text), "%d", current_wpm);
    lv_canvas_draw_text(canvas, 0, 100, SCREEN_WIDTH, &label_dsc, wpm_text);
}
